### **IMP (Implementation Plan): "万象全书" (Universal Guide) 模组开发**

*   **项目代号:** Project Atlas
*   **版本:** 1.0 (Draft)
*   **日期:** 2023年10月27日
*   **状态:** 草案

#### **摘要 (Abstract)**

本项目旨在基于现有的CanKaoMod进行改造，开发一个名为"万象全书"的多功能指南模组。该模组以一本出生自带的书籍为载体，通过三个核心阶段的开发，从一个静态的新手指南，逐步演进为一个集成了团队协作规划工具和AI智能问答助手的综合性游戏内信息中心，最终目标是无缝化游戏体验，减少玩家对外部工具的依赖。

#### **动机 (Motivation)**

1.  **降低新手门槛:** 新手玩家常常需要频繁切换窗口查询攻略，严重打断游戏沉浸感。
2.  **解决团队规划痛点:** 生存建设类游戏中，团队成员间的信息同步和任务规划是核心痛点。"今天我们该干啥？"是常见问题。
3.  **拥抱前沿技术:** 将LLM技术集成到游戏中，提供一种全新的、即时的、上下文相关的问答体验，是模组功能的未来探索方向。

---

### **实施计划清单 (Implementation Checklist)**

#### **阶段 0: 准备工作 (Prerequisites)**

* [x] 分析现有CanKaoMod的结构和功能
* [x] 确认可以复用的组件和需要新增的功能
* [x] 修改模组信息以反映新的功能和名称

#### **阶段 1: 初级版 - 静态攻略书 (The Static Codex)**

* **核心目标: 一个包含预设图文内容、可翻页、有目录、能记忆位置的书。**

**[1.1] 物品创建 (Item Prefab)**

* [x] 基于现有的book_petrify.lua创建新的atlas_book.lua
* [x] 复用现有物品资源
  * [x] 使用现有的book_fossil图标和资源
  * [x] 避免重新生成.tex和.xml文件
* [x] 添加核心组件
  * [x] 使其可被携带
  * [x] 定义右键使用行为

**[1.3] 核心功能实现 (Core Logic)**

* [x] 出生自带
  * [x] 监听玩家激活事件
  * [x] 首次进入世界时给予书本
* [x] 记忆位置
  * [x] 在UI关闭时保存当前章节ID
  * [x] 在UI打开时读取并跳转到上次的页面

**[1.2] UI 界面开发 (User Interface)**

* [x] 创建UI定义文件atlasbook_ui.lua
* [x] 编写UI基础框架
* [x] 布局设计与实现
  * [x] 创建背景、目录区和内容区
* [x] 内容数据化
  * [x] 创建atlas_book_data.lua存储章节内容
  * [x] 使用游戏现有图片素材
* [x] 动态内容实现
  * [x] 加载数据并创建内容控件
  * [x] 编写更新内容的函数
* [x] 目录按钮实现
* [x] 连接物品与UI

**[1.4] Bug修复与优化**

* [x] 修复UI关闭问题
  * [x] 修复阅读一次后再次阅读不会弹出UI的问题
  * [x] 修复阅读后无法移动角色的问题
* [x] 添加游戏暂停/恢复功能
* [x] 添加标签页切换功能的基础结构
* [x] 添加翻页功能
* [x] 添加记忆功能

---

#### **阶段 2: 中级版 - 协作规划器 (The Collaborative Planner)**

* **核心目标: 在书中集成一个团队共享、实时同步的 Todolist。**

**[2.1] UI 扩展 (UI Extension)**

* [x] 在书本UI中添加"团队计划"标签页
* [x] 添加必要控件
  * [x] 文本输入框
  * [x] "添加任务"按钮
  * [x] 可滚动的列表区域
  * [x] 任务模板（文本、复选框、删除按钮）

**[2.2] 数据结构与存储 (Data Structure)**

* [x] 服务器端数据结构设计
* [x] 客户端数据同步机制

**[2.3] 网络同步 (Networking - RPC)**

* [x] 客户端到服务器的通信
  * [x] 添加任务
  * [x] 更新任务状态
  * [x] 删除任务
* [x] 服务器端处理
* [x] 服务器到客户端的广播
* [x] 客户端UI更新

---

#### **阶段 3: 高级版 - AI 助手 (The AI Assistant)**

* **核心目标: 集成一个可以通过 API 调用外部 LLM 的问答模块。**

**[3.1] 配置与UI (Configuration & UI)**

* [ ] 创建模组配置
  * [ ] 添加API Key输入框
* [ ] UI扩展
  * [ ] 添加"智能问答"标签页
  * [ ] 添加提问输入框和按钮
  * [ ] 添加加载指示器
  * [ ] 添加答案显示区域

**[3.2] 异步网络请求 (Asynchronous HTTP)**

* [ ] 选择HTTP请求实现方法
* [ ] 实现异步调用
  * [ ] 封装网络请求逻辑
  * [ ] 启动协程
  * [ ] 构造HTTP请求
* [ ] 处理响应
  * [ ] 解析返回的JSON数据
  * [ ] 更新UI
* [ ] 错误处理

**[3.3] 体验优化 (UX Improvements)**

* [ ] 实现异步问答
* [ ] 答案持久化与推送
  * [ ] 保存问题和答案
  * [ ] 添加屏幕提示
  * [ ] 自动加载上次的问答记录

---

### **技术细节与实现注意事项**

1. **现有资源利用:**
   - 复用CanKaoMod中的prefab创建机制
   - 利用现有的book_petrify.lua作为模板
   - 使用现有图片资源，避免重新编译

2. **新增文件:**
   - scripts/prefabs/atlas_book.lua ✓
   - scripts/widgets/atlasbook_ui.lua ✓
   - scripts/atlas_book_data.lua (集成到atlasbook_ui.lua中) ✓
   - modsettings.lua (阶段3)

3. **修改文件:**
   - modinfo.lua (更新模组信息) ✓
   - modmain.lua (添加新的prefab和UI注册) ✓

4. **资源准备:**
   - 使用现有的书本图标和资源 ✓
   - 使用游戏内现有图片作为攻略内容素材 ✓
   - 设计UI界面的布局和样式 ✓

5. **兼容性考虑:**
   - 确保新功能不影响现有CanKaoMod的功能 ✓
   - 考虑多人游戏中的同步问题
   - 优化性能，避免影响游戏流畅度

6. **测试计划:**
   - 每完成一个小功能点就进行测试
   - 分阶段测试，确保每个阶段功能正常后再进入下一阶段
   - 记录测试结果和问题，及时修复

### **当前进度**

已完成：
1. 修改模组信息
2. 创建atlas_book.lua物品预制体
3. 添加出生自带功能
4. 添加多语言支持
5. 创建UI界面
6. 实现攻略内容的显示
7. 实现目录导航功能
8. 修复UI关闭和角色移动问题
9. 添加游戏暂停/恢复功能
10. 添加翻页和记忆功能
11. 阶段2：添加团队协作规划器
   - 添加了"团队计划"标签页
   - 实现了任务列表的UI
   - 添加了任务输入功能
   - 实现了服务器端存储和客户端同步
   - 添加了任务的添加、完成和删除功能
   - 实现了多人游戏中的任务同步

下一步：
1. 阶段3：添加AI助手功能
   - 创建模组配置
   - 添加"智能问答"标签页
   - 实现HTTP请求
   - 添加答案显示区域 